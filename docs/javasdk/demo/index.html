<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/ckb_sdk/blog/rss.xml" title="My Site Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/ckb_sdk/blog/atom.xml" title="My Site Blog Atom Feed"><title data-react-helmet="true">Demo | My Site</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Demo | My Site"><meta data-react-helmet="true" name="description" content="Get the Block Chain Information"><meta data-react-helmet="true" property="og:description" content="Get the Block Chain Information"><meta data-react-helmet="true" property="og:url" content="https://github.com/xying21/ckb_sdk/ckb_sdk/docs/javasdk/demo"><link data-react-helmet="true" rel="shortcut icon" href="/ckb_sdk/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://github.com/xying21/ckb_sdk/ckb_sdk/docs/javasdk/demo"><link rel="stylesheet" href="/ckb_sdk/styles.b72c9eed.css">
<link rel="preload" href="/ckb_sdk/styles.ea5d29ff.js" as="script">
<link rel="preload" href="/ckb_sdk/runtime~main.ac579250.js" as="script">
<link rel="preload" href="/ckb_sdk/main.f556c6ed.js" as="script">
<link rel="preload" href="/ckb_sdk/common.0817146d.js" as="script">
<link rel="preload" href="/ckb_sdk/2.14a26ece.js" as="script">
<link rel="preload" href="/ckb_sdk/33.a207836e.js" as="script">
<link rel="preload" href="/ckb_sdk/34.1f4b8071.js" as="script">
<link rel="preload" href="/ckb_sdk/f976f453.9ee76f0e.js" as="script">
<link rel="preload" href="/ckb_sdk/17896441.8d83a66f.js" as="script">
<link rel="preload" href="/ckb_sdk/27aa7a46.e5cc02ec.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/ckb_sdk/"><img src="/ckb_sdk/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/ckb_sdk/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">My Site</strong></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/ckb_sdk/"><img src="/ckb_sdk/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/ckb_sdk/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">My Site</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_vMrn"><main class="docMainContainer_2iGs"><div class="container padding-vert--lg docItemWrapper_1bxp"><div class="row"><div class="col docItemCol_U38p"><div class="docItemContainer_a7m4"><article><header><h1 class="docTitle_Oumm">Demo</h1></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="get-the-block-chain-information"></a>Get the Block Chain Information<a class="hash-link" href="#get-the-block-chain-information" title="Direct link to heading">#</a></h2><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="get-the-current-block-number"></a>Get the Current Block Number<a class="hash-link" href="#get-the-current-block-number" title="Direct link to heading">#</a></h2><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="get-the-current-block-information"></a>Get the Current Block Information<a class="hash-link" href="#get-the-current-block-information" title="Direct link to heading">#</a></h2><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="dao-operations"></a>DAO Operations<a class="hash-link" href="#dao-operations" title="Direct link to heading">#</a></h2><div class="mdxCodeBlock_1zKU"><div style="color:#bfc7d5;background-color:#292d3e" class="codeBlockTitle_2eSY">ckb-sdk-java/example/src/main/java/org/nervos/ckb/NervosDaoExample.java</div><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-java codeBlock_tuNs thin-scrollbar codeBlockWithTitle_1UkA"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">package org.nervos.ckb;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import static org.nervos.ckb.utils.Const.*;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import java.io.IOException;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import java.math.BigInteger;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import java.util.ArrayList;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import java.util.Arrays;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import java.util.Collections;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import java.util.List;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.crypto.secp256k1.Sign;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.indexer.*;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.service.Api;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.system.SystemContract;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.system.type.SystemScriptCell;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.transaction.*;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.type.Block;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.type.OutPoint;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.type.Script;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.type.Witness;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.type.cell.CellDep;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.type.cell.CellInput;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.type.cell.CellOutput;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.type.cell.CellWithStatus;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.type.fixed.UInt64;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.type.transaction.Transaction;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.type.transaction.TransactionWithStatus;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.utils.EpochUtils;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.utils.Numeric;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.utils.Utils;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/** Copyright Â© 2019 Nervos Foundation. All rights reserved. */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public class NervosDaoExample {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  private static final String NERVOS_DAO_DATA = &quot;0x0000000000000000&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  private static final int DAO_LOCK_PERIOD_EPOCHS = 180;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  private static final int DAO_MATURITY_BLOCKS = 5;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  private static Api api;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  private static CkbIndexerApi ckbIndexerApi;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  private static String DaoTestPrivateKey =</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;08730a367dfabcadb805d69e0e613558d5160eb8bab9d6e326980c2c46a05db2&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  private static String DaoTestAddress = &quot;ckt1qyqxgp7za7dajm5wzjkye52asc8fxvvqy9eqlhp82g&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  private static final String DEPOSIT = &quot;deposit&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  private static final String WITHDRAW_PHASE1 = &quot;withdraw&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  private static final String WITHDRAW_PHASE2 = &quot;claim&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  static {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    api = new Api(NODE_URL, false);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ckbIndexerApi = new CkbIndexerApi(CKB_INDEXER_URL, false);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  public static void main(String[] args) throws Exception {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (args.length &gt; 0) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      if (DEPOSIT.equals(args[0])) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        System.out.println(&quot;Before depositing, balance: &quot; + getBalance(DaoTestAddress) + &quot; CKB&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Transaction transaction = generateDepositingToDaoTx(Utils.ckbToShannon(1000));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        String txHash = api.sendTransaction(transaction);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        System.out.println(&quot;Nervos DAO deposit tx hash: &quot; + txHash);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // Waiting some time to make tx into blockchain</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        System.out.println(&quot;After depositing, balance: &quot; + getBalance(DaoTestAddress) + &quot; CKB&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      } else if (WITHDRAW_PHASE1.equals(args[0])) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // Nervos DAO withdraw phase1 must be after 4 epoch of depositing transaction</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        String depositTxHash = args[1];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        OutPoint depositOutPoint = new OutPoint(depositTxHash, &quot;0x0&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Transaction transaction = generateWithdrawingFromDaoTx(depositOutPoint);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        String txHash = api.sendTransaction(transaction);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        System.out.println(&quot;Nervos DAO withdraw phase1 tx hash: &quot; + txHash);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      } else if (WITHDRAW_PHASE2.equals(args[0])) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // Nervos DAO withdraw phase2 must be after 180 epoch of depositing transaction</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        String withdrawTxHash = args[1];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        TransactionWithStatus withdrawTx = api.getTransaction(withdrawTxHash);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        OutPoint depositOutPoint = withdrawTx.transaction.inputs.get(0).previousOutput;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        OutPoint withdrawOutPoint = new OutPoint(withdrawTxHash, &quot;0x0&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Transaction transaction =</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            generateClaimingFromDaoTx(depositOutPoint, withdrawOutPoint, Utils.ckbToShannon(0.01));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        String txHash = api.sendTransaction(transaction);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        System.out.println(&quot;Nervos DAO withdraw phase2 tx hash: &quot; + txHash);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // Waiting some time to make tx into blockchain</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        System.out.println(&quot;After withdrawing, balance: &quot; + getBalance(DaoTestAddress) + &quot; CKB&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  private static String getBalance(String address) throws IOException {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return new IndexerCollector(api, ckbIndexerApi)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        .getCapacity(address)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        .divide(UnitCKB)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        .toString(10);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  private static Transaction generateDepositingToDaoTx(BigInteger capacity) throws IOException {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Script type =</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        new Script(SystemContract.getSystemNervosDaoCell(api).cellHash, &quot;0x&quot;, Script.TYPE);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    IndexerCollector txUtils = new IndexerCollector(api, ckbIndexerApi);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    List&lt;CellOutput&gt; cellOutputs =</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        txUtils.generateOutputs(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Collections.singletonList(new Receiver(DaoTestAddress, capacity)), DaoTestAddress);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    cellOutputs.get(0).type = type;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    List&lt;String&gt; cellOutputsData = Arrays.asList(NERVOS_DAO_DATA, &quot;0x&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    List&lt;ScriptGroupWithPrivateKeys&gt; scriptGroupWithPrivateKeysList = new ArrayList&lt;&gt;();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    TransactionBuilder txBuilder = new TransactionBuilder(api);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    txBuilder.addOutputs(cellOutputs);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    txBuilder.setOutputsData(cellOutputsData);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    txBuilder.addCellDep(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        new CellDep(SystemContract.getSystemNervosDaoCell(api).outPoint, CellDep.CODE));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // You can get fee rate by rpc or set a simple number</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    BigInteger feeRate = BigInteger.valueOf(1024);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    IndexerCollector indexerCollector = new IndexerCollector(api, ckbIndexerApi);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    CollectResult collectResult =</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        indexerCollector.collectInputs(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Collections.singletonList(DaoTestAddress),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            txBuilder.buildTx(),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            feeRate,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Sign.SIGN_LENGTH * 2);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // update change output capacity after collecting cells</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    cellOutputs.get(cellOutputs.size() - 1).capacity = collectResult.changeCapacity;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    txBuilder.setOutputs(cellOutputs);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    int startIndex = 0;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    for (CellsWithAddress cellsWithAddress : collectResult.cellsWithAddresses) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      txBuilder.addInputs(cellsWithAddress.inputs);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      for (int i = 0; i &lt; cellsWithAddress.inputs.size(); i++) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        txBuilder.addWitness(i == 0 ? new Witness(Witness.SIGNATURE_PLACEHOLDER) : &quot;0x&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      scriptGroupWithPrivateKeysList.add(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          new ScriptGroupWithPrivateKeys(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              new ScriptGroup(NumberUtils.regionToList(startIndex, cellsWithAddress.inputs.size())),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              Collections.singletonList(DaoTestPrivateKey)));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      startIndex += cellsWithAddress.inputs.size();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Secp256k1SighashAllBuilder signBuilder = new Secp256k1SighashAllBuilder(txBuilder.buildTx());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    for (ScriptGroupWithPrivateKeys scriptGroupWithPrivateKeys : scriptGroupWithPrivateKeysList) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      signBuilder.sign(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          scriptGroupWithPrivateKeys.scriptGroup, scriptGroupWithPrivateKeys.privateKeys.get(0));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return signBuilder.buildTx();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  private static Transaction generateWithdrawingFromDaoTx(OutPoint depositOutPoint)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      throws IOException {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    CellWithStatus cellWithStatus = api.getLiveCell(depositOutPoint, true);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (!CellWithStatus.Status.LIVE.getValue().equals(cellWithStatus.status)) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      throw new IOException(&quot;Cell is not yet live!&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    TransactionWithStatus transactionWithStatus = api.getTransaction(depositOutPoint.txHash);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (!TransactionWithStatus.Status.COMMITTED</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        .getValue()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        .equals(transactionWithStatus.txStatus.status)) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      throw new IOException(&quot;Transaction is not committed yet!&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Block depositBlock = api.getBlock(transactionWithStatus.txStatus.blockHash);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    BigInteger depositBlockNumber = Numeric.toBigInt(depositBlock.header.number);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    CellOutput cellOutput = cellWithStatus.cell.output;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    String outputData = Numeric.toHexString(new UInt64(depositBlockNumber).toBytes());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Script lock = LockUtils.generateLockScriptWithAddress(DaoTestAddress);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    CellOutput changeOutput = new CellOutput(&quot;0x0&quot;, lock);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    List&lt;CellOutput&gt; cellOutputs = Arrays.asList(cellOutput, changeOutput);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    List&lt;String&gt; cellOutputsData = Arrays.asList(outputData, &quot;0x&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    List&lt;String&gt; headerDeps = Collections.singletonList(depositBlock.header.hash);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    List&lt;ScriptGroupWithPrivateKeys&gt; scriptGroupWithPrivateKeysList = new ArrayList&lt;&gt;();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    TransactionBuilder txBuilder = new TransactionBuilder(api);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    txBuilder.addCellDep(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        new CellDep(SystemContract.getSystemNervosDaoCell(api).outPoint, CellDep.CODE));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    txBuilder.setOutputsData(cellOutputsData);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    txBuilder.setHeaderDeps(headerDeps);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    txBuilder.addOutputs(cellOutputs);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    txBuilder.addInput(new CellInput(depositOutPoint, &quot;0x0&quot;));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // You can get fee rate by rpc or set a simple number</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    BigInteger feeRate = BigInteger.valueOf(1024);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    IndexerCollector indexerCollector = new IndexerCollector(api, ckbIndexerApi);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    CollectResult collectResult =</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        indexerCollector.collectInputs(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Collections.singletonList(DaoTestAddress),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            txBuilder.buildTx(),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            feeRate,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Sign.SIGN_LENGTH * 2);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // update change output capacity after collecting cells</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    cellOutputs.get(cellOutputs.size() - 1).capacity = collectResult.changeCapacity;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    txBuilder.setOutputs(cellOutputs);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    CellsWithAddress cellsWithAddress = collectResult.cellsWithAddresses.get(0);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    txBuilder.setInputs(cellsWithAddress.inputs);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    for (int i = 0; i &lt; cellsWithAddress.inputs.size(); i++) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      if (i == 0) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        txBuilder.addWitness(new Witness(Witness.SIGNATURE_PLACEHOLDER));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      } else {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        txBuilder.addWitness(&quot;0x&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ScriptGroup scriptGroup =</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        new ScriptGroup(NumberUtils.regionToList(0, cellsWithAddress.inputs.size()));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    scriptGroupWithPrivateKeysList.add(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        new ScriptGroupWithPrivateKeys(scriptGroup, Collections.singletonList(DaoTestPrivateKey)));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Secp256k1SighashAllBuilder signBuilder = new Secp256k1SighashAllBuilder(txBuilder.buildTx());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    for (ScriptGroupWithPrivateKeys scriptGroupWithPrivateKeys : scriptGroupWithPrivateKeysList) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      signBuilder.sign(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          scriptGroupWithPrivateKeys.scriptGroup, scriptGroupWithPrivateKeys.privateKeys.get(0));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return signBuilder.buildTx();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  private static Transaction generateClaimingFromDaoTx(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      OutPoint depositOutPoint, OutPoint withdrawingOutPoint, BigInteger fee) throws IOException {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Script lock = LockUtils.generateLockScriptWithAddress(DaoTestAddress);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    CellWithStatus cellWithStatus = api.getLiveCell(withdrawingOutPoint, true);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (!CellWithStatus.Status.LIVE.getValue().equals(cellWithStatus.status)) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      throw new IOException(&quot;Cell is not yet live!&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    TransactionWithStatus transactionWithStatus = api.getTransaction(withdrawingOutPoint.txHash);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (!TransactionWithStatus.Status.COMMITTED</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        .getValue()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        .equals(transactionWithStatus.txStatus.status)) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      throw new IOException(&quot;Transaction is not committed yet!&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    BigInteger depositBlockNumber =</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        new UInt64(Numeric.hexStringToByteArray(cellWithStatus.cell.data.content)).getValue();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Block depositBlock = api.getBlockByNumber(Numeric.toHexStringWithPrefix(depositBlockNumber));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    EpochUtils.EpochInfo depositEpoch = EpochUtils.parse(depositBlock.header.epoch);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Block withdrawBlock = api.getBlock(transactionWithStatus.txStatus.blockHash);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    EpochUtils.EpochInfo withdrawEpoch = EpochUtils.parse(withdrawBlock.header.epoch);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    long withdrawFraction = withdrawEpoch.index * depositEpoch.length;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    long depositFraction = depositEpoch.index * withdrawEpoch.length;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    long depositedEpochs = withdrawEpoch.number - depositEpoch.number;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (withdrawFraction &gt; depositFraction) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      depositedEpochs += 1;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    long lockEpochs =</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        (depositedEpochs + (DAO_LOCK_PERIOD_EPOCHS - 1))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            / DAO_LOCK_PERIOD_EPOCHS</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            * DAO_LOCK_PERIOD_EPOCHS;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    long minimalSinceEpochNumber = depositEpoch.number + lockEpochs;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    long minimalSinceEpochIndex = depositEpoch.index;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    long minimalSinceEpochLength = depositEpoch.length;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    String minimalSince =</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        EpochUtils.generateSince(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            minimalSinceEpochLength, minimalSinceEpochIndex, minimalSinceEpochNumber);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    String outputCapacity =</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        api.calculateDaoMaximumWithdraw(depositOutPoint, withdrawBlock.header.hash);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    CellOutput cellOutput =</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        new CellOutput(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Numeric.toHexStringWithPrefix(Numeric.toBigInt(outputCapacity).subtract(fee)), lock);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SystemScriptCell secpCell = SystemContract.getSystemSecpCell(api);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SystemScriptCell nervosDaoCell = SystemContract.getSystemNervosDaoCell(api);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Transaction tx =</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        new Transaction(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;0x0&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Arrays.asList(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                new CellDep(secpCell.outPoint, CellDep.DEP_GROUP),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                new CellDep(nervosDaoCell.outPoint)),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Arrays.asList(depositBlock.header.hash, withdrawBlock.header.hash),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Collections.singletonList(new CellInput(withdrawingOutPoint, minimalSince)),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Collections.singletonList(cellOutput),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Collections.singletonList(&quot;0x&quot;),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Collections.singletonList(new Witness(&quot;&quot;, NERVOS_DAO_DATA, &quot;&quot;)));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return tx.sign(Numeric.toBigInt(DaoTestPrivateKey));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Run the main method of the <code>NervosDaoExample</code> class by using gradle wrapper:</p><details><summary>CLICK ME</summary><p></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-shell codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">cd</span><span class="token plain"> myDapp</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ ./gradlew run --args</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;deposit&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> Task :run</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Before depositing, balance: </span><span class="token number" style="color:rgb(247, 140, 108)">602964</span><span class="token plain"> CKB</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Nervos DAO deposit tx hash: 0xbc6acfb5f83620841157c25713afd2bccdd1451de0a3ab688b5010b4c30a1695</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">After depositing, balance: </span><span class="token number" style="color:rgb(247, 140, 108)">602964</span><span class="token plain"> CKB</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Deprecated Gradle features were used </span><span class="token keyword" style="font-style:italic">in</span><span class="token plain"> this build, making it incompatible with Gradle </span><span class="token number" style="color:rgb(247, 140, 108)">8.0</span><span class="token plain">.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Use </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;--warning-mode all&#x27;</span><span class="token plain"> to show the individual deprecation warnings.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">See https://docs.gradle.org/7.0.2/userguide/command_line_interface.html</span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#sec:command_line_warnings</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">BUILD SUCCESSFUL </span><span class="token keyword" style="font-style:italic">in</span><span class="token plain"> 1s</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token plain"> actionable tasks: </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"> executed, </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"> up-to-date</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p></p></details><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="transfer-ckb-to-a-multisig-address"></a>Transfer CKB to a Multisig Address<a class="hash-link" href="#transfer-ckb-to-a-multisig-address" title="Direct link to heading">#</a></h2><div class="mdxCodeBlock_1zKU"><div style="color:#bfc7d5;background-color:#292d3e" class="codeBlockTitle_2eSY">ckb-sdk-java/example/src/main/java/org/nervos/ckb/SendToMultiSigAddressTxExample.java</div><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-java codeBlock_tuNs thin-scrollbar codeBlockWithTitle_1UkA"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">package org.nervos.ckb;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import static org.nervos.ckb.utils.Const.*;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import java.io.IOException;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import java.math.BigInteger;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import java.util.ArrayList;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import java.util.Collections;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import java.util.List;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.crypto.secp256k1.Sign;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.indexer.*;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.service.Api;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.transaction.*;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.type.Witness;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.type.cell.CellOutput;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.utils.Utils;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/** Copyright Â© 2019 Nervos Foundation. All rights reserved. */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public class SendToMultiSigAddressTxExample {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  private static Api api;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  private static CkbIndexerApi ckbIndexerApi;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  private static String MultiSigAddress = &quot;ckt1qyqlqn8vsj7r0a5rvya76tey9jd2rdnca8lqh4kcuq&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  private static String TestPrivateKey =</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;d00c06bfd800d27397002dca6fb0993d5ba6399b4238b2f29ee9deb97593d2bc&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  private static String TestAddress = &quot;ckt1qyqvsv5240xeh85wvnau2eky8pwrhh4jr8ts8vyj37&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  static {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    api = new Api(NODE_URL, false);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ckbIndexerApi = new CkbIndexerApi(CKB_INDEXER_URL, false);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  public static void main(String[] args) throws Exception {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    List&lt;Receiver&gt; receivers =</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Collections.singletonList(new Receiver(MultiSigAddress, Utils.ckbToShannon(20000)));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    String changeAddress = &quot;ckt1qyqvsv5240xeh85wvnau2eky8pwrhh4jr8ts8vyj37&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    System.out.println(&quot;Before transferring, sender&#x27;s balance: &quot; + getBalance() + &quot; CKB&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    System.out.println(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;Before transferring, multi-sig address balance: &quot; + getMultiSigBalance() + &quot; CKB&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    System.out.println(&quot;Before transferring, change address balance: &quot; + getBalance() + &quot; CKB&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    String hash = sendCapacity(receivers, changeAddress);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    System.out.println(&quot;Transaction hash: &quot; + hash);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // waiting transaction into block, sometimes you should wait more seconds</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Thread.sleep(30000);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    System.out.println(&quot;After transferring, sender&#x27;s address balance: &quot; + getBalance() + &quot; CKB&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    System.out.println(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;After transferring, multi-sig address balance: &quot; + getMultiSigBalance() + &quot; CKB&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    System.out.println(&quot;After transferring, change address balance: &quot; + getBalance() + &quot; CKB&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  private static String getBalance() throws IOException {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return new IndexerCollector(api, ckbIndexerApi)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        .getCapacity(TestAddress)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        .divide(UnitCKB)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        .toString(10);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  private static String getMultiSigBalance() throws IOException {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return new IndexerCollector(api, ckbIndexerApi)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        .getCapacity(MultiSigAddress)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        .divide(UnitCKB)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        .toString(10);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  private static String sendCapacity(List&lt;Receiver&gt; receivers, String changeAddress)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      throws IOException {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    TransactionBuilder txBuilder = new TransactionBuilder(api);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    IndexerCollector txUtils = new IndexerCollector(api, ckbIndexerApi);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    List&lt;CellOutput&gt; cellOutputs = txUtils.generateOutputs(receivers, changeAddress);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    txBuilder.addOutputs(cellOutputs);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    List&lt;ScriptGroupWithPrivateKeys&gt; scriptGroupWithPrivateKeysList = new ArrayList&lt;&gt;();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // You can get fee rate by rpc or set a simple number</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    BigInteger feeRate = BigInteger.valueOf(1024);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // initial_length = 2 * secp256k1_signature_byte.length</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    CollectResult collectResult =</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        txUtils.collectInputs(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Collections.singletonList(TestAddress),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            txBuilder.buildTx(),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            feeRate,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Sign.SIGN_LENGTH * 2);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // update change cell output capacity after collecting cells</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    cellOutputs.get(cellOutputs.size() - 1).capacity = collectResult.changeCapacity;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    txBuilder.setOutputs(cellOutputs);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    int startIndex = 0;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    for (CellsWithAddress cellsWithAddress : collectResult.cellsWithAddresses) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      txBuilder.addInputs(cellsWithAddress.inputs);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      for (int i = 0; i &lt; cellsWithAddress.inputs.size(); i++) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        txBuilder.addWitness(i == 0 ? new Witness(Witness.SIGNATURE_PLACEHOLDER) : &quot;0x&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      scriptGroupWithPrivateKeysList.add(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          new ScriptGroupWithPrivateKeys(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              new ScriptGroup(NumberUtils.regionToList(startIndex, cellsWithAddress.inputs.size())),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              Collections.singletonList(TestPrivateKey)));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Secp256k1SighashAllBuilder signBuilder = new Secp256k1SighashAllBuilder(txBuilder.buildTx());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    for (ScriptGroupWithPrivateKeys scriptGroupWithPrivateKeys : scriptGroupWithPrivateKeysList) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      signBuilder.sign(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          scriptGroupWithPrivateKeys.scriptGroup, scriptGroupWithPrivateKeys.privateKeys.get(0));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return api.sendTransaction(signBuilder.buildTx());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Run the main method of the <code>SendToMultiSigAddressTxExample</code> class by using gradle:</p><details><summary>CLICK ME</summary><p></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-shell codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">cd</span><span class="token plain"> myDapp</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ gradle run</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> Task :run</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Before transferring, sender</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;s balance: 20001406910 CKB</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">Before transferring, multi-sig address balance: 0 CKB</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">Before transferring, change address balance: 20001406910 CKB</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">Transaction hash: 0x99340f20e59915c66dd802c7fe98c56e91728a1e1a9ba0b426c500472b7ba5d1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">After transferring, sender&#x27;</span><span class="token plain">s address balance: </span><span class="token number" style="color:rgb(247, 140, 108)">20002391844</span><span class="token plain"> CKB</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">After transferring, multi-sig address balance: </span><span class="token number" style="color:rgb(247, 140, 108)">20000</span><span class="token plain"> CKB</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">After transferring, change address balance: </span><span class="token number" style="color:rgb(247, 140, 108)">20002391844</span><span class="token plain"> CKB</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p></p></details><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="transfer-ckb-to-multiple-receivers"></a>Transfer CKB to Multiple Receivers<a class="hash-link" href="#transfer-ckb-to-multiple-receivers" title="Direct link to heading">#</a></h2><div class="mdxCodeBlock_1zKU"><div style="color:#bfc7d5;background-color:#292d3e" class="codeBlockTitle_2eSY">ckb-sdk-java/example/src/main/java/org/nervos/ckb/SingleSigWithCkbIndexerTxExample.java</div><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-java codeBlock_tuNs thin-scrollbar codeBlockWithTitle_1UkA"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">package org.nervos.ckb;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import static org.nervos.ckb.utils.Const.*;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import java.io.IOException;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import java.math.BigInteger;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import java.util.ArrayList;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import java.util.Arrays;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import java.util.Collections;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import java.util.List;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.address.AddressUtils;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.address.Network;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.crypto.secp256k1.ECKeyPair;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.crypto.secp256k1.Sign;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.indexer.*;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.service.Api;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.transaction.*;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.type.Witness;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.type.cell.CellOutput;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.type.transaction.Transaction;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.utils.Numeric;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.utils.Utils;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/** Copyright Â© 2019 Nervos Foundation. All rights reserved. */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public class SingleSigWithCkbIndexerTxExample {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  private static Api api;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  private static CkbIndexerApi ckbIndexerApi;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  private static List&lt;String&gt; SendPrivateKeys;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  private static List&lt;String&gt; SendAddresses;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  private static List&lt;String&gt; ReceiveAddresses;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  static {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    api = new Api(NODE_URL, false);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ckbIndexerApi = new CkbIndexerApi(CKB_INDEXER_URL, false);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SendPrivateKeys =</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Arrays.asList(&quot;e79f3207ea4980b7fed79956d5934249ceac4751a4fae01a0f7c4a96884bc4e3&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SendAddresses = Arrays.asList(&quot;ckt1qyqrdsefa43s6m882pcj53m4gdnj4k440axqswmu83&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ReceiveAddresses =</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Arrays.asList(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;ckt1qyqvsv5240xeh85wvnau2eky8pwrhh4jr8ts8vyj37&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;ckt1qyqtnz38fht9nvmrfdeunrhdtp29n0gagkps4duhek&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;ckt1qg8mxsu48mncexvxkzgaa7mz2g25uza4zpz062relhjmyuc52ps3zn47dugwyk5e6mgxvlf5ukx7k3uyq9wlkkmegke&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  public static void main(String[] args) throws Exception {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    AddressUtils utils = new AddressUtils(Network.TESTNET);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    for (int i = 0; i &lt; SendAddresses.size() - 1; i++) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      String testPublicKey = ECKeyPair.publicKeyFromPrivate(SendPrivateKeys.get(i));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      String address = SendAddresses.get(i);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      if (!address.equals(utils.generateFromPublicKey(testPublicKey))) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        System.out.println(&quot;Private key and address &quot; + address + &quot; are not matched&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    System.out.println(&quot;Wait some time for ckb-indexer running&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    List&lt;Receiver&gt; receivers =</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Arrays.asList(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            new Receiver(ReceiveAddresses.get(0), Utils.ckbToShannon(200)),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            new Receiver(ReceiveAddresses.get(1), Utils.ckbToShannon(200)),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            new Receiver(ReceiveAddresses.get(2), Utils.ckbToShannon(300)));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    System.out.println(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;Before transferring, first sender&#x27;s balance: &quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            + getBalance(SendAddresses.get(0)).divide(UnitCKB).toString(10)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            + &quot; CKB&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    String hash = sendCapacity(receivers, SendAddresses.get(0));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    System.out.println(&quot;Transaction hash: &quot; + hash);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // waiting transaction into block, sometimes you should wait more seconds</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Thread.sleep(30000);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    System.out.println(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;After transferring, first sender&#x27;s balance: &quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            + getBalance(SendAddresses.get(0)).divide(UnitCKB).toString(10)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            + &quot; CKB&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  private static BigInteger getBalance(String address) throws IOException {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return new IndexerCollector(api, ckbIndexerApi).getCapacity(address);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  private static String sendCapacity(List&lt;Receiver&gt; receivers, String changeAddress)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      throws IOException {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    List&lt;ScriptGroupWithPrivateKeys&gt; scriptGroupWithPrivateKeysList = new ArrayList&lt;&gt;();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    TransactionBuilder txBuilder = new TransactionBuilder(api);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    IndexerCollector txUtils = new IndexerCollector(api, ckbIndexerApi);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    List&lt;CellOutput&gt; cellOutputs = txUtils.generateOutputs(receivers, changeAddress);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    txBuilder.addOutputs(cellOutputs);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // You can get fee rate by rpc or set a simple number</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    BigInteger feeRate = BigInteger.valueOf(1024);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // initial_length = 2 * secp256k1_signature_byte.length</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // collectInputsWithIndexer method uses indexer rpc to collect cells quickly</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    CollectResult collectResult =</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        txUtils.collectInputs(SendAddresses, txBuilder.buildTx(), feeRate, Sign.SIGN_LENGTH * 2);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // update change cell output capacity after collecting cells if there is changeOutput</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (Numeric.toBigInt(collectResult.changeCapacity).compareTo(BigInteger.ZERO) &gt; 0) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      cellOutputs.get(cellOutputs.size() - 1).capacity = collectResult.changeCapacity;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      txBuilder.setOutputs(cellOutputs);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    int startIndex = 0;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    for (CellsWithAddress cellsWithAddress : collectResult.cellsWithAddresses) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      txBuilder.addInputs(cellsWithAddress.inputs);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      for (int i = 0; i &lt; cellsWithAddress.inputs.size(); i++) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        txBuilder.addWitness(i == 0 ? new Witness(Witness.SIGNATURE_PLACEHOLDER) : &quot;0x&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      if (cellsWithAddress.inputs.size() &gt; 0) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        scriptGroupWithPrivateKeysList.add(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            new ScriptGroupWithPrivateKeys(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                new ScriptGroup(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    NumberUtils.regionToList(startIndex, cellsWithAddress.inputs.size())),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                Collections.singletonList(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    SendPrivateKeys.get(SendAddresses.indexOf(cellsWithAddress.address)))));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        startIndex += cellsWithAddress.inputs.size();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Secp256k1SighashAllBuilder signBuilder = new Secp256k1SighashAllBuilder(txBuilder.buildTx());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    for (ScriptGroupWithPrivateKeys scriptGroupWithPrivateKeys : scriptGroupWithPrivateKeysList) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      signBuilder.sign(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          scriptGroupWithPrivateKeys.scriptGroup, scriptGroupWithPrivateKeys.privateKeys.get(0));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Transaction tx = signBuilder.buildTx();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return api.sendTransaction(tx);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Run the main method of the <code>SingleSigWithCkbIndexerTxExample</code> class by using gradle:</p><details><summary>CLICK ME</summary><p></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-shell codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">cd</span><span class="token plain"> myDapp</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ gradle run</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> Task :run</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Before transferring, sender</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;s balance: 20001406910 CKB</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">Before transferring, multi-sig address balance: 0 CKB</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">Before transferring, change address balance: 20001406910 CKB</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">Transaction hash: 0x99340f20e59915c66dd802c7fe98c56e91728a1e1a9ba0b426c500472b7ba5d1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">After transferring, sender&#x27;</span><span class="token plain">s address balance: </span><span class="token number" style="color:rgb(247, 140, 108)">20002391844</span><span class="token plain"> CKB</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">After transferring, multi-sig address balance: </span><span class="token number" style="color:rgb(247, 140, 108)">20000</span><span class="token plain"> CKB</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">After transferring, change address balance: </span><span class="token number" style="color:rgb(247, 140, 108)">20002391844</span><span class="token plain"> CKB</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p></p></details><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="transfer-all-balance"></a>Transfer all Balance<a class="hash-link" href="#transfer-all-balance" title="Direct link to heading">#</a></h2><div class="mdxCodeBlock_1zKU"><div style="color:#bfc7d5;background-color:#292d3e" class="codeBlockTitle_2eSY">ckb-sdk-java/example/src/main/java/org/nervos/ckb/TransferAllBalanceWithCkbIndexerExample.java</div><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-java codeBlock_tuNs thin-scrollbar codeBlockWithTitle_1UkA"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">package org.nervos.ckb;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import static org.nervos.ckb.utils.Const.*;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import java.io.IOException;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import java.math.BigInteger;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import java.util.ArrayList;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import java.util.Collections;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import java.util.List;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.address.AddressUtils;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.address.Network;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.crypto.secp256k1.ECKeyPair;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.crypto.secp256k1.Sign;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.indexer.*;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.service.Api;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.transaction.*;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.type.Witness;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.type.cell.CellOutput;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.type.transaction.Transaction;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.utils.Numeric;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import org.nervos.ckb.utils.Utils;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/** Copyright Â© 2019 Nervos Foundation. All rights reserved. */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public class TransferAllBalanceWithCkbIndexerExample {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  private static Api api;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  private static CkbIndexerApi ckbIndexerApi;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  private static List&lt;String&gt; SendPrivateKeys;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  private static List&lt;String&gt; SendAddresses;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  private static List&lt;String&gt; ReceiveAddresses;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  static {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    api = new Api(NODE_URL, false);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ckbIndexerApi = new CkbIndexerApi(CKB_INDEXER_URL, false);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SendPrivateKeys =</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Collections.singletonList(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;d00c06bfd800d27397002dca6fb0993d5ba6399b4238b2f29ee9deb97593d2bc&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SendAddresses = Collections.singletonList(&quot;ckt1qyqvsv5240xeh85wvnau2eky8pwrhh4jr8ts8vyj37&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ReceiveAddresses = Collections.singletonList(&quot;ckt1qyqxvnycu7tdtyuejn3mmcnl4y09muxz8c3s2ewjd4&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  public static void main(String[] args) throws Exception {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    AddressUtils utils = new AddressUtils(Network.TESTNET);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    for (int i = 0; i &lt; SendAddresses.size() - 1; i++) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      String testPublicKey = ECKeyPair.publicKeyFromPrivate(SendPrivateKeys.get(i));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      String address = SendAddresses.get(i);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      if (!address.equals(utils.generateFromPublicKey(testPublicKey))) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        System.out.println(&quot;Private key and address &quot; + address + &quot; are not matched&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    System.out.println(&quot;Wait some time for ckb-indexer running&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    List&lt;Receiver&gt; receivers =</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Collections.singletonList(new Receiver(ReceiveAddresses.get(0), Utils.ckbToShannon(100)));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    System.out.println(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;Before transferring, first sender&#x27;s balance: &quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            + getBalance(SendAddresses.get(0)).divide(UnitCKB).toString(10)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            + &quot; CKB&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // For transferring all balance, change address is set to be null</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Because the transfer of the entire balance will not set the change cell, you need to</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // carefully calculate the transfer amount</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    String hash = sendCapacity(receivers, null);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    System.out.println(&quot;Transaction hash: &quot; + hash);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // waiting transaction into block, sometimes you should wait more seconds</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Thread.sleep(30000);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    System.out.println(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;After transferring, first sender&#x27;s balance: &quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            + getBalance(SendAddresses.get(0)).divide(UnitCKB).toString(10)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            + &quot; CKB&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  private static BigInteger getBalance(String address) throws IOException {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return new IndexerCollector(api, ckbIndexerApi).getCapacity(address);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  private static String sendCapacity(List&lt;Receiver&gt; receivers, String changeAddress)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      throws IOException {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    List&lt;ScriptGroupWithPrivateKeys&gt; scriptGroupWithPrivateKeysList = new ArrayList&lt;&gt;();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    TransactionBuilder txBuilder = new TransactionBuilder(api);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    IndexerCollector txUtils = new IndexerCollector(api, ckbIndexerApi);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    List&lt;CellOutput&gt; cellOutputs = txUtils.generateOutputs(receivers, changeAddress);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    txBuilder.addOutputs(cellOutputs);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // You can get fee rate by rpc or set a simple number</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    BigInteger feeRate = BigInteger.valueOf(1024);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // initial_length = 2 * secp256k1_signature_byte.length</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // collectInputsWithIndexer method uses indexer rpc to collect cells quickly</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    CollectResult collectResult =</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        txUtils.collectInputs(SendAddresses, txBuilder.buildTx(), feeRate, Sign.SIGN_LENGTH * 2);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // update change cell output capacity after collecting cells if there is changeOutput</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (Numeric.toBigInt(collectResult.changeCapacity).compareTo(BigInteger.ZERO) &gt; 0) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      cellOutputs.get(cellOutputs.size() - 1).capacity = collectResult.changeCapacity;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      txBuilder.setOutputs(cellOutputs);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    int startIndex = 0;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    for (CellsWithAddress cellsWithAddress : collectResult.cellsWithAddresses) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      txBuilder.addInputs(cellsWithAddress.inputs);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      for (int i = 0; i &lt; cellsWithAddress.inputs.size(); i++) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        txBuilder.addWitness(i == 0 ? new Witness(Witness.SIGNATURE_PLACEHOLDER) : &quot;0x&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      if (cellsWithAddress.inputs.size() &gt; 0) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        scriptGroupWithPrivateKeysList.add(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            new ScriptGroupWithPrivateKeys(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                new ScriptGroup(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    NumberUtils.regionToList(startIndex, cellsWithAddress.inputs.size())),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                Collections.singletonList(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    SendPrivateKeys.get(SendAddresses.indexOf(cellsWithAddress.address)))));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        startIndex += cellsWithAddress.inputs.size();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Secp256k1SighashAllBuilder signBuilder = new Secp256k1SighashAllBuilder(txBuilder.buildTx());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    for (ScriptGroupWithPrivateKeys scriptGroupWithPrivateKeys : scriptGroupWithPrivateKeysList) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      signBuilder.sign(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          scriptGroupWithPrivateKeys.scriptGroup, scriptGroupWithPrivateKeys.privateKeys.get(0));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Transaction tx = signBuilder.buildTx();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return api.sendTransaction(tx);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Run the main method of the <code>TransferAllBalanceWithCkbIndexerExample</code> class by using gradle:</p><details><summary>CLICK ME</summary><p></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-shell codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">cd</span><span class="token plain"> myDapp</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ gradle run</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> Task :run</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Wait some </span><span class="token function" style="color:rgb(130, 170, 255)">time</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> ckb-indexer running</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Before transferring, first sender</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;s balance: 20005808806 CKB</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">Transaction hash: 0x7fd0a39a559c4d3c7043849365e58b82ed3d4bdf8b3344fa2fdf3ea18c7fd098</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">After transferring, first sender&#x27;</span><span class="token plain">s balance: </span><span class="token number" style="color:rgb(247, 140, 108)">20005607818</span><span class="token plain"> CKB</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p></p></details></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/facebook/docusaurus/edit/master/website/docs/javasdk/demo.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2LL7"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#get-the-block-chain-information" class="table-of-contents__link">Get the Block Chain Information</a></li><li><a href="#get-the-current-block-number" class="table-of-contents__link">Get the Current Block Number</a></li><li><a href="#get-the-current-block-information" class="table-of-contents__link">Get the Current Block Information</a></li><li><a href="#dao-operations" class="table-of-contents__link">DAO Operations</a></li><li><a href="#transfer-ckb-to-a-multisig-address" class="table-of-contents__link">Transfer CKB to a Multisig Address</a></li><li><a href="#transfer-ckb-to-multiple-receivers" class="table-of-contents__link">Transfer CKB to Multiple Receivers</a></li><li><a href="#transfer-all-balance" class="table-of-contents__link">Transfer all Balance</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" activebasepath="docs" position="right" href="/ckb_sdk/docs/introduction/overview">Docs</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/ckb_sdk/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/ckb_sdk/styles.ea5d29ff.js"></script>
<script src="/ckb_sdk/runtime~main.ac579250.js"></script>
<script src="/ckb_sdk/main.f556c6ed.js"></script>
<script src="/ckb_sdk/common.0817146d.js"></script>
<script src="/ckb_sdk/2.14a26ece.js"></script>
<script src="/ckb_sdk/33.a207836e.js"></script>
<script src="/ckb_sdk/34.1f4b8071.js"></script>
<script src="/ckb_sdk/f976f453.9ee76f0e.js"></script>
<script src="/ckb_sdk/17896441.8d83a66f.js"></script>
<script src="/ckb_sdk/27aa7a46.e5cc02ec.js"></script>
</body>
</html>